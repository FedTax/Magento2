# TaxCloud Magento2 Extension - Development Context

## Project Overview
This is a Magento2 extension for TaxCloud sales tax compliance service. The extension handles sales tax calculation, collection, and filing for Adobe Commerce/Magento Open Source stores.

## Adobe Commerce 2.4.8-p1 Compatibility

### ‚úÖ **Compatible Features**
- **PHP 8.1+**: Fully compatible (tested with PHP 8.4.10)
- **SOAP Client**: SOAP extension and client instantiation work correctly
- **Anonymous Classes**: Observer pattern anonymous classes function properly
- **Throwable Exception Handling**: Modern exception handling patterns work

### ‚ö†Ô∏è **Known Compatibility Issues**
- **SerializerInterface**: Not available in standalone test environment (requires Magento framework)
- **ObserverInterface**: Not available in standalone test environment (requires Magento framework)
- **Note**: These interfaces are available when running within actual Magento environment

### üß™ **Compatibility Testing**
```bash
# Run Adobe Commerce 2.4.8-p1 compatibility tests
make test-compatibility

# Run all compatibility tests
php Test/Integration/AdobeCommerce248p1CompatibilityTest.php
```

**Compatibility Test Coverage:**
- **PHP 8.1+ Compatibility**: Version requirements and features
- **SOAP Client**: Extension loading and client instantiation
- **Anonymous Classes**: Observer pattern functionality
- **Throwable Handling**: Modern exception handling patterns
- **Array Operations**: Data structure handling and validation
- **String Operations**: Text processing and manipulation
- **SOAP Parameters**: API parameter handling and type safety
- **Error Handling**: Error suppression and reporting control

**Current Status**: ‚úÖ **8/8 tests PASSED** - Fully compatible with Adobe Commerce 2.4.8-p1

## Key Files & Directories

### Core Extension Files
- `Model/Api.php` - Main API integration with TaxCloud services
- `Model/Tax.php` - Tax calculation logic
- `Model/PostalCodeParser.php` - ZIP code parsing and validation
- `Observer/Sales/` - Event observers for order lifecycle
- `etc/` - Configuration and dependency injection files

### Testing
- `Test/Integration/` - Integration tests (can run without PHPUnit)
- `Test/Unit/` - Unit tests (require PHPUnit framework)
- `run-test.sh` - Docker-based test runner
- `Makefile` - Test automation commands

## Development Commands

### Running Tests
```bash
# Run all tests using Docker (recommended)
make test

# Run tests locally (requires PHP)
make test-local

# Run individual test files
php Test/Integration/PostalCodeParserTest.php
php Test/Integration/RefundTest.php
```

### Test Coverage
- **Integration Tests**: 31 tests covering core functionality
- **Unit Tests**: Require PHPUnit framework (not included)
- **Test Focus**: Refund handling, postal code parsing, API integration

## Key Features
1. **Sales Tax Calculation** - Real-time tax rates from TaxCloud
2. **Address Verification** - TaxCloud address validation API
3. **Order Management** - Tax capture and refund handling
4. **Postal Code Parsing** - Flexible ZIP+4 code handling
5. **Event System** - Extensible observer pattern for customization

## Configuration
- Admin configuration under Stores ‚Üí Configuration ‚Üí Sales ‚Üí Tax
- Requires TaxCloud API credentials (API ID and Key)
- Configurable taxability information codes (TIC) per product
- Address verification and logging options

## Compatibility
- **Adobe Commerce 2.4.8-p1**: ‚úÖ Compatible (Version 1.1.0+)
- **Magento Open Source 2.4.x**: ‚úÖ Supported
- **PHP**: 8.1+ recommended

## Development Notes
- Extension follows Magento2 module structure standards
- Uses dependency injection and event observers
- Comprehensive error handling and logging
- SOAP API integration with TaxCloud services
- Refund functionality includes special handling for delivery fees

## Common Development Tasks
1. **Adding New Tax Rules**: Extend the Tax model
2. **Custom Event Handling**: Use existing observer pattern
3. **API Integration**: Extend the Api model for new TaxCloud endpoints
4. **Testing**: Add new tests to Integration or Unit test directories

## Dependencies
- Magento2 Framework
- TaxCloud API credentials
- PHP SOAP extension (for API calls)

## Troubleshooting
- Check `var/log/taxcloud.log` for API call logs
- Verify TaxCloud API credentials in admin configuration
- Test postal code parsing with various formats
- Ensure proper shipping origin address configuration
